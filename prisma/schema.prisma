// Prisma Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums removed for SQLite compatibility
// UserRole: ADMIN, MANAGER, TEAM_LEAD, WORKER, CUSTOMER
// JobStatus: PENDING, IN_PROGRESS, COMPLETED, ON_HOLD, CANCELLED
// ApprovalStatus: PENDING, APPROVED, REJECTED

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  passwordHash  String
  role          String    @default("WORKER") // UserRole
  phone         String?
  avatarUrl     String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  customerProfile Customer?
  teamMember      TeamMember?
  managedTeams    Team[]        @relation("TeamLead")
  assignedJobs    JobAssignment[]
  createdJobs     Job[]         @relation("JobCreator")
  notifications   Notification[]
  approvals       Approval[]    @relation("Approver")
  requestedApprovals Approval[] @relation("Requester")
  completedSteps  JobStep[]     @relation("StepCompleter")
  uploadedPhotos  StepPhoto[]
  createdCosts    CostTracking[] @relation("CostCreator")
  approvedCosts   CostTracking[] @relation("CostApprover")

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

model Customer {
  id          String   @id @default(cuid())
  userId      String   @unique
  company     String
  address     String?
  taxId       String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs        Job[]

  @@index([userId])
  @@index([company])
  @@map("customers")
}

model Team {
  id          String   @id @default(cuid())
  name        String
  leadId      String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lead        User?    @relation("TeamLead", fields: [leadId], references: [id])
  members     TeamMember[]
  assignments JobAssignment[]

  @@index([leadId])
  @@index([isActive])
  @@index([name])
  @@map("teams")
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String   @unique
  joinedAt  DateTime @default(now())

  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model Job {
  id             String    @id @default(cuid())
  title          String
  description    String?
  customerId     String
  creatorId      String
  status         String    @default("PENDING") // JobStatus
  priority       String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  location       String?
  latitude       Float?
  longitude      Float?
  scheduledDate  DateTime?
  scheduledEndDate DateTime?
  completedDate  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  customer       Customer  @relation(fields: [customerId], references: [id])
  creator        User      @relation("JobCreator", fields: [creatorId], references: [id])
  steps          JobStep[]
  assignments    JobAssignment[]
  costs          CostTracking[]
  approvals      Approval[]

  @@index([customerId])
  @@index([creatorId])
  @@index([status])
  @@index([priority])
  @@index([scheduledDate])
  @@index([completedDate])
  @@index([createdAt])
  @@index([status, priority])
  @@index([customerId, status])
  @@map("jobs")
}

model JobStep {
  id          String   @id @default(cuid())
  jobId       String
  title       String
  description String?
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  startedAt   DateTime?
  blockedAt   DateTime?
  blockedReason String?  // POWER_OUTAGE, MATERIAL_SHORTAGE, etc.
  blockedNote String?
  order       Int
  
  // FotoÄŸraf veya not eklenebilir
  notes       String?
  photoUrl    String?
  photoUrls   String?  // JSON array of Cloudinary URLs

  completedById String?
  completedBy   User?    @relation("StepCompleter", fields: [completedById], references: [id])

  subSteps    JobSubStep[]
  photos      StepPhoto[]

  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([isCompleted])
  @@index([completedById])
  @@index([order])
  @@index([jobId, isCompleted])
  @@map("job_steps")
}

model JobSubStep {
  id          String   @id @default(cuid())
  stepId      String
  title       String
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  startedAt   DateTime?
  blockedAt   DateTime?
  blockedReason String?
  blockedNote String?
  order       Int
  photoUrls   String?  // JSON array of Cloudinary URLs

  step        JobStep  @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([stepId])
  @@index([isCompleted])
  @@index([order])
  @@index([stepId, isCompleted])
  @@map("job_sub_steps")
}

model StepPhoto {
  id          String   @id @default(cuid())
  stepId      String
  url         String
  uploadedAt  DateTime @default(now())
  uploadedById String
  
  step        JobStep  @relation(fields: [stepId], references: [id], onDelete: Cascade)
  uploadedBy  User     @relation(fields: [uploadedById], references: [id])

  @@index([stepId])
  @@index([uploadedById])
  @@index([uploadedAt])
  @@map("step_photos")
}

model JobAssignment {
  id        String   @id @default(cuid())
  jobId     String
  teamId    String?
  workerId  String?
  assignedAt DateTime @default(now())

  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  team      Team?    @relation(fields: [teamId], references: [id])
  worker    User?    @relation(fields: [workerId], references: [id])

  @@index([jobId])
  @@index([teamId])
  @@index([workerId])
  @@index([assignedAt])
  @@index([jobId, teamId])
  @@map("job_assignments")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  isRead    Boolean  @default(false)
  type      String   // INFO, WARNING, SUCCESS, ERROR
  link      String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([userId, isRead])
  @@map("notifications")
}

model Approval {
  id          String   @id @default(cuid())
  jobId       String
  requesterId String
  approverId  String?
  status      String   @default("PENDING") // ApprovalStatus
  type        String   // JOB_COMPLETION, COST_APPROVAL, etc.
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  requester   User     @relation("Requester", fields: [requesterId], references: [id])
  approver    User?    @relation("Approver", fields: [approverId], references: [id])

  @@index([jobId])
  @@index([status])
  @@index([requesterId])
  @@index([approverId])
  @@index([createdAt])
  @@index([status, jobId])
  @@map("approvals")
}

model CostTracking {
  id          String   @id @default(cuid())
  jobId       String
  description String
  amount      Float
  currency    String   @default("TRY")
  date        DateTime @default(now())
  category    String?  // MATERIAL, LABOR, TRANSPORT, FOOD, ACCOMMODATION, OTHER
  
  // New fields
  receiptUrl      String?
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  rejectionReason String?
  
  createdById     String
  approvedById    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  createdBy   User     @relation("CostCreator", fields: [createdById], references: [id])
  approvedBy  User?    @relation("CostApprover", fields: [approvedById], references: [id])

  @@index([jobId])
  @@index([createdById])
  @@index([approvedById])
  @@index([status])
  @@index([createdAt])
  @@index([jobId, status])
  @@map("cost_tracking")
}
